#summary Server installation guide.
#labels Doc-Userguide

= Introduction =

The cv_web_tk server supports multiple components: 
 * mech_turk task server 
 * VOC competition server
 * Annotation storage and access server
 * CV Web models

This installation guide guide walks through the installation of the common components and the mech turk server. Other components can be installed separately as django applications.

The installation assumes a bare Ubuntu linux 9.10 machine. It has been tested on
 * Karmik Ubuntu (9.10) in vmware player (Link to the final image).

These instructions assume no knowledge of django and the goal to install this server only. If you know, what's going on, feel free to skip steps and use other features. For example, you can use any database of your choice, change code and data locaitions, etc.


= Prerequisites =
 # Install Ubuntu 9.10
 # Install all package updates
 # Install mysql, python, python-mysqldb 
{{{
sudo apt-get install mysql-server python python-mysqldb 
}}}
 # Recommended: Install phpmyadmin. It greatly helps in database administration. It will ask, which server to configure. Choose apache2. Make sure to write down the passwords.
{{{
sudo apt-get install phpmyadmin
}}}
 # Install PIL (python imaging library) if it hasn't been installed. It's used for on-the-fly image manipulations and converting images.
{{{
sudo apt-get install python-imaging
}}}

= ROS install =

ROS provides great software management tools and many components of the server are ROS packages. For certain cases, the installation can be omitted, but it's really easy to install. It will download lots of stuff though.

The instructions come from [http://www.ros.org/wiki/ROS/Installation ros.org]. We create a system-wide install, but we don't really need full shared install (we skip marking as NO_BUILD):
{{{
sudo apt-get install build-essential python-yaml cmake subversion

wget --no-check-certificate http://ros.org/rosinstall -O ~/rosinstall
chmod 755 ~/rosinstall
sudo ~/rosinstall /opt/ros http://ros.org/rosconfigs/all.rosconfig 
}}}

Now we need to compile packages used by the server
{{{
sudo bash
source /opt/ros/setup.sh
rosmake --rosdep-install cv_mech_turk2 mech_turk_ros
}}}

= Libraries and packages =

 # django 1.1.1
{{{
wget http://www.djangoproject.com/download/1.1.1/tarball/
tar xzvf Django-1.1.1.tar.gz
cd Django-1.1.1
sudo python setup.py install
}}}
 # Install boto (for Mechanical Turk integration) with a patch.
{{{
wget http://boto.googlecode.com/files/boto-1.8d.tar.gz
tar xvzf boto-1.8d.tar.gz
wget http://cv-web-annotation-toolkit.googlecode.com/files/boto-1.8d_patch
cd boto-1.8d
patch -p1 <../boto-1.8d_patch
sudo python setup.py install
}}}
 # django-tagging  (v.0.3.0 for django 1.0.2)
{{{
wget http://django-tagging.googlecode.com/files/django-tagging-0.3.tar.gz
tar xvzf django-tagging-0.3.tar.gz
cd django-tagging-0.3
sudo python setup.py install
}}}
 # django-registration
{{{
wget http://bitbucket.org/ubernostrum/django-registration/get/v0.7.tar.gz
tar xvzf v0.7.tar.gz
cd django-registration
sudo python setup.py install
}}}
 # rpc4django
{{{
wget http://www.davidfischer.name/wp-content/uploads/2010/01/rpc4django-0.1.7.tar.gz
tar xvfz rpc4django-0.1.7.tar.gz
cd rpc4django-0.1.7
python setup.py install
}}}

= Django code installation =

 # Set up a mysql database
   * Go to phpmyadmin at http://localhost/phpmyadmin
   * Choose create database (e.g. *crowd*)
   * Create a user for the database:
     * Go to database crowd, click Privileges
     * Click create user (e.g. *crowd_django*), 
     * Click generate password and save it somewhere
     * Check "Grant all privileges on database *crowd*" 
 # Choose server code location and create server dir
{{{
SRV_ROOT=/var/django
sudo mkdir $SRV_ROOT
sudo chown -R <<MY_USER>> $SRV_ROOT
cd $SRV_ROOT
django-admin.py createproject crowd_server
cd crowd_server
}}}
 # Download the code components from the SVN. Replace syrnick with your google code account. Or remove the user and https to get read-only code.
{{{
export GCUSER=syrnick
svn checkout https://cv-web-annotation-toolkit.googlecode.com/svn/trunk/django/web_annotations_server/mturk/ mturk/ --username $GCUSER
svn checkout https://cv-web-annotation-toolkit.googlecode.com/svn/trunk/django/web_annotations_server/templates/ templates/ --username $GCUSER
svn checkout https://cv-web-annotation-toolkit.googlecode.com/svn/trunk/django/web_annotations_server/packages/ packages/ --username $GCUSER
svn checkout https://cv-web-annotation-toolkit.googlecode.com/svn/trunk/django/web_annotations_server/snippets/ snippets/ --username $GCUSER
svn checkout https://cv-web-annotation-toolkit.googlecode.com/svn/trunk/django/web_annotations_server/datastore/ datastore/ --username $GCUSER
svn checkout https://cv-web-annotation-toolkit.googlecode.com/svn/trunk/django/web_annotations_server/default_project/ default_project/ --username $GCUSER
}}}
 # Copy default configuration over the initial project values.
{{{
cp default_project/*.py ./
}}}
 # Edit settings.py to specify your database connection and other local settings
 # Run syncdb to create the database tables:
{{{
python manage.py syncdb
}}}
 # Load initial configuration data
{{{
export PYTHONPATH=$PYTHONPATH:/var/django:/var/django/crowd_server
export DJANGO_SETTINGS_MODULE=crowd_server.settings
django-admin.py loaddata default_project/default.json
}}}
 # Create required data directories
{{{
sudo mkdir /var/datasets/
sudo mkdir /var/datasets/tasks/
sudo mkdir /var/datasets/segmentations/
sudo chown -R www-data /var/datasets/
sudo chown -R www-data /var/django
}}}
 # Run development server
{{{
python manage.py runserver localhost:8080
}}}

= Installation into Apache =

 # Install and enable mod_python 
{{{
sudo apt-get install libapache2-mod-python
}}}
 # Download django_crowd.conf and install it into /etc/apache2/conf.d
{{{
wget http://cv-web-annotation-toolkit.googlecode.com/files/django_crowd.conf
sudo mv django_crowd.conf /etc/apache2/conf.d/
}}}
 # Edit django_crowd.conf to match the directories with the local installation.
    * Update django code path (from /var/django)
    * Update ROS paths (from /opt/ros)
    * Update admin templates path (from /usr/local/lib/python2.6/dist-packages/django/contrib/admin/media)
 # Restart the apache
{{{
sudo apache2ctl restart
}}}
 # Compare the [http://localhost/ apache site] with the [http://localhost:8080/ development server]. They should be identical.

Note:  Django development server will immediately pick up all changes, but Apache will not.
Note2: This configuration serves many static files through django. This is a performance issue and those files should be served through another server.
Note3: If apache is configured to works through https, we can use https in HOST_NAME_FOR_MTURK in settings.py. This way Mechanical Turk will use a secure connection to the server. 

== Installing Unit Test server ==

Unit test server assumes specific configuration of tasks and sessions on the server. 

To install test server fixtures:
 # Start with a blank database or create a new database and change settings.py. Be careful!!
 # Download and extract the test fixture data:
{{{
wget http://cv-web-annotation-toolkit.googlecode.com/files/django_crowd_test_fixture_0.1.0.tgz
tar xvzf django_crowd_test_fixture_0.1.0.tgz
}}}
 # Load the test fixtures into the database
{{{
django-admin.py loaddata django_crowd_test_fixture_0.1.0/test_fixture.json
}}}
 # Copy the session images to /var/datasets
{{{
sudo cp -r django_crowd_test_fixture_0.1.0/test-bbox-data-1 /var/datasets/
sudo chown -R www-data /var/datasets/test-bbox-data-1
}}}