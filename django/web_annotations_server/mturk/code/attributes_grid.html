<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>prototype</title>
<script language="javascript">AC_FL_RunContent = 0;</script>
<script language="javascript" src="js/prototype.js" > </script>
<script language="javascript" src="js/mt.js" > </script>
<script src="/code/js/easy_selection.js"></script>
<script src="js/AC_RunActiveContent.js" language="javascript"></script>
<style>
.even {background-color:#FFF;}
.odd {background-color:#BBB;}

.bad {background-color:#F00;}
.with_errors {background-color:#0F0;}
.exceptional {background-color:#00F;}
.grade_msg {background-color:#FFF; }

</style>
</head>

<body bgcolor="#ffffff">


<form id="MT_form" name="MT_form" action="http://www.mturk.com/mturk/externalSubmit" onsubmit="return mt_submit_handler();" method="POST">

IMPORTANT: Read the <a id="a_instructions" href="instructions.html" target="wnd_instructions">instructions</a>!! <!--<b>Instructions have been updated!</b><br/>-->



<div id="rating_div" style="display:none;"></div>



<div id="task_results_raw"></div>

<div id="task_content">Loading attributes task...</div>





<noscript>
Error. Javascript is required.
</noscript>
<hr/>
Any comments/suggestions/etc: <input type=text name="Comments" id="Comments" value="">
<hr/>

<div id="submit_div">
<input type=hidden name="assignmentId" id="assignmentId" value="">
<input type=hidden name="hitId" id="hitId" value="ignored">
<input type=hidden name="sites" id="sites" value="">
<input type=hidden name="extid" id="extid" value="">
<input type=hidden name="ExtID" id="ExtID" value="">
<input type=hidden name="session" id="session" value="">
<input type=hidden name="workerId" id="workerId" value="">
<input type=hidden name="mode" id="mode" value="">

<input type=hidden name="load_time" id="load_time" value="">
<input type=hidden name="submit_time" id="submit_time" value="">


<input type=submit>

</div>



</form>


<script language="javascript">

//
// This method Gets URL Parameters (GUP)
//
function gup( name )
{
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var tmpURL = window.location.href;
  var results = regex.exec( tmpURL );
  if( results == null )
    return "";
  else
    return results[1];
}

//
// This method decodes the query parameters that were URL-encoded
//
function decode(strToDecode)
{
  var encoded = strToDecode;
  return unescape(encoded.replace(/\+/g,  " "));
}



    document.getElementById('assignmentId').value = gup('assignmentId');


    //
    // Check if the worker is PREVIEWING the HIT or if they've ACCEPTED the HIT
    //
    mode_value="AmazonMTproduction"

    if (gup('assignmentId') == "ASSIGNMENT_ID_NOT_AVAILABLE")
    {
        mode_value=="AmazonMTproduction"
        // If we're previewing, disable the button and give it a helpful message
	//document.getElementById('submitButton').disabled = true;
	//document.getElementById('submitButton').value = "You must ACCEPT the HIT before you can submit the results.";
    } else {
        var form = document.getElementById('MT_form');
        if (document.referrer && ( document.referrer.indexOf('workersandbox') != -1) ) {
            form.action = "http://workersandbox.mturk.com/mturk/externalSubmit";
	    mode_value="AmazonMTsandbox";
        }
    }



query_args=document.location.toString();
query_args=query_args.split("?")[1];
args_list=query_args.split("&");

no_mode_in_query=1;
rating="";
workerId="";
for (i = 0; i <= args_list.length; i++)
{
	arg=args_list[i];
	if(arg){
	arg_pair=arg.split("=");
	arg_n=arg_pair[0];
	arg_v=arg_pair[1];
	if( arg_n=="assignmentId"){
		$('MT_form')[arg_n].value=arg_v;
	}else if( arg_n=="hitId"){
		$('MT_form')[arg_n].value=arg_v;
	}else if( arg_n=="workerId"){
	  workerId=arg_v;
		$('MT_form')[arg_n].value=arg_v;
	}else if( arg_n=="extid"){
	        $('MT_form')[arg_n].value=arg_v;
	}else if( arg_n=="ExtID"){
	        $('MT_form')[arg_n].value=arg_v;
	}else if( arg_n=="session"){
	        $('MT_form')[arg_n].value=arg_v;
	}else if( arg_n=="mode"){
	        no_mode_in_query=0;
		$('MT_form')[arg_n].value=arg_v;
		mode_value=arg_v;
	}
	}
}
if( rating!=""){
    $('rating_div').innerHTML="Current rating: "+rating;
    $('rating_div').style.display='block';
}

instructions_URL=unescape(gup("instructions"));
$('a_instructions').href=instructions_URL;



if ( no_mode_in_query){
    query_args=query_args+"&mode="+mode_value
}

submitURL="";
if(mode_value=="AmazonMTsandbox"){
	submitURL="http://workersandbox.mturk.com/mturk/externalSubmit";
}else if(mode_value=="AmazonMTproduction"){
	submitURL="http://www.mturk.com/mturk/externalSubmit";
}else if(mode_value=="MT2"){
	submitURL="/mt/submit/";
}else if(mode_value=="sandbox2"){
	submitURL="/mt/submit/";
}else if(mode_value=="input"){
	submitURL="/mt/submit/";
}
$('MT_form').action=submitURL;

//$F('extid').value=gup('ExtID');





var create_flash=function(id,src,w,h,play)
{
	swf='video_display';
	swf_w=w;
	swf_h=h;
	query_args='video_url='+src;
	if(play=="play"){
		 query_args+="&video_mode=play";
        }

	return AC_FL_RunContent2(
		 'codebase', 'http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0',
		 'width', swf_w,
		 'height', swf_h,
		 'src', swf,
		 'quality', 'high',
		 'pluginspage', 'http://www.macromedia.com/go/getflashplayer',
		 'align', 'middle',
		 'play', 'true"',
		 'loop', 'true',
		 'scale', 'showall',
		 'wmode', 'window',
		 'devicefont', 'false',
		 'id', 'annotation_gui',
		 'bgcolor', '#ffffff',
		 'name', 'annotation_gui',
		 'menu', 'true',
		 'allowFullScreen', 'false',
		 'allowScriptAccess','always',
		 'movie', swf,
		 'salign', '',
		 'FlashVars', query_args
	 ); //end AC code
 }



///TASK - specific block




var parameters_data;
var parameters_display_html_str;
var parameters_header_html_str;

var task_data;
var annotation_data;

var parameters_done=0;
var data_done=0;
var annotation_done=0;



var task_header_template = new Template('#{attributes_header}');

var img_task_template = new Template('<tr id=\"task_#{id}\"><td><img src=\"#{src}\"></td>#{attributes_html}</tr>');
var video_task_template = new Template('<tr id=\"task_#{id}\"><td>#{flash_str}</td>#{attributes_html}</tr>');

var annotation_show_template = new Template('<td>#{id}:#{grade}</td>');




var check_after_load=function()
{
  var all_done = 0;
  if(mode_value=="input")
    {
      if(parameters_done && data_done)
      {
        all_done = 1;
      }
    }
  else if(mode_value=="display" || mode_value=="edit" )
    {
      if(parameters_done && data_done && annotation_done)
      {
        all_done = 1;
      }
    } 

  if(all_done)
    {

      var items=task_data.getElementsByTagName('item');

      s= "<table border='1' class='task_table'>"+task_header_template.evaluate({attributes_header:parameters_header_html_str});

      for( var iID=0;iID<items.length;iID++)
      {
	var i=items[iID];
	var id = i.getAttribute("id");
	var obj_type = i.getAttribute("type");
	var src = i.getAttribute("src");

	objID="A_obj"+id;
	updated_html = parameters_display_html_str.replace(/ATTR/g,objID).replace("<display_html>","").replace("</display_html>","");

	var task_template;

	if(obj_type=="image")
        {
	  task_template=img_task_template;
   	  s += task_template.evaluate({id: id, src:src, attributes_html:updated_html  });
        }else if(obj_type=="video")
        {
	  task_template=video_task_template;
	  flash_str = create_flash(id,src,320,240,1);

   	  s += task_template.evaluate({id: id, flash_str:flash_str, src:src, attributes_html:updated_html  });
        }



      }
      s += task_header_template.evaluate({attributes_header:parameters_header_html_str});
      s += "</table>";

      $('task_content').innerHTML = s;
      
      if( mode_value == "display" )
        {

	  var attributes_root = parameters_data.getElementsByTagName('attributes')[0];
          var attributes=attributes_root.getElementsByTagName('attribute');  
          var attribute_names=[];			  
          for( var aID=0;aID<attributes.length;aID++)
          {
            var attr_id=attributes[aID].getAttribute('id');
	    attribute_names[aID]= attr_id ;
          }

	alert(attribute_names);
	  var objects=annotation_data.getElementsByTagName('object');
			       
          for( var oID=0;oID<objects.length;oID++)
          {
	     var object=objects[oID];
	     var obj_id = object.getAttribute('id');
			       alert(obj_id);
             for( var aID=0;aID<attribute_names.length;aID++)
             {
				  continue;
		var attr=object.getAttribute(attribute_names[aID]);
				  alert(attr);
		if(attr)
		{
                  f=$('MT_form')['A_obj'+obj_id+'_'+attribute_names[aID]];
		  if(f.type=="checkbox")
		  {			
		    if(attr=="on")f.checked=1;
		  }else if(f.type=="select-one"){
		    f.value=attr;

		  }else{
  		    for( var fID=0;fID<f.length;fID++)
		    {
			var field=f[fID];
			if(field.value==attr)
			{
			  field.checked=true;
			  break;
			}
		    }
		  }
		}
             }
          }
	  var comments=annotation_data.getElementsByTagName('comments');
	  var comments_str="";
	  for(var iC=0;iC<comments.length;iC++)
	  { 
	    comments_str += comments[iC].getAttribute('text');
	  }
          $('Comments').value=comments_str;
       }
    }

			  
};

var onParametersXMLLoaded=function(transport)
{
  if (transport.responseXML)
  {
    parameters_data = transport.responseXML;

    display_html=parameters_data.getElementsByTagName('display_html')[0];
    parameters_display_html_str = ( (new XMLSerializer()).serializeToString(display_html));

    header_html=parameters_data.getElementsByTagName('header_html')[0];
    parameters_header_html_str = ( (new XMLSerializer()).serializeToString(header_html));


    parameters_done=1;
    check_after_load();			 
  }
};


var onTaskXMLLoaded=function(transport)
{
  if (transport.responseXML)
  {
    task_data = transport.responseXML;

    data_done=1;
    check_after_load();
  }


};


var onAnnotationXMLLoaded=function(transport)
{
  if (transport.responseXML)
  {
    annotation_data = transport.responseXML;
    annotation_done=1;
    check_after_load();			 

  }
}



///// END of task-specific data

var now = new Date();
$('load_time').value=now.toUTCString();

if(mode_value=="display")
  {
    $('submit_div').style.display="none";

    params_URL=unescape(gup("parameters_url"));

    var upd=new Ajax.Request(params_URL, {
			       method: 'get',
			       onSuccess: onParametersXMLLoaded,
			     });

    tasks_URL=unescape(gup("data_url"));

    var upd=new Ajax.Request(tasks_URL, {
			       method: 'get',
			       onSuccess: onTaskXMLLoaded,
			     });

    var annotation_URL=unescape(gup("annotation_url"));
    var upd=new Ajax.Request(annotation_URL, {
			       method: 'get',
			       onSuccess: onAnnotationXMLLoaded,
			     });
  }
else
  {
    params_URL=unescape(gup("parameters_url"));

    var upd1=new Ajax.Request(params_URL, {
			       method: 'get',
			       onSuccess: onParametersXMLLoaded,
			     });

    tasks_URL=unescape(gup("data_url"));

    var upd=new Ajax.Request(tasks_URL, {
			       method: 'get',
			       onSuccess: onTaskXMLLoaded,
			     });


  }
</script>




</body>
</html>
